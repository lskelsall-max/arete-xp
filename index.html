<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Komorebi OS ‚Äî Master Protocol</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      /* Komorebi brand palette */
      --komorebi-mint: #66c5a5;
      --komorebi-mint-soft: #7ed6b7;
      --bg-deep: #050f0a;
      --bg-forest: #08150e;
      --card: #0e2016;
      --card-soft: #13271c;
      --accent-gold: #f5c15c;
      --accent-gold-soft: rgba(245, 193, 92, 0.14);
      --accent-gold-strong: #ffdf8f;
      --text-main: #f5f7f4;
      --text-muted: #a5b4ac;
      --border-subtle: #1f3125;
      --danger: #f97373;
      --success: #4ade80;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0.75rem;
      background: linear-gradient(to bottom, var(--komorebi-mint) 0, var(--bg-forest) 140px, var(--bg-deep) 100%);
      color: var(--text-main);
      min-height: 100vh;
      position: relative;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 2;
    }

    /* HEADER */
    .app-header {
      margin-bottom: 0.4rem;
      padding-bottom: 0.2rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    }

    .app-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .app-title-block { display: flex; flex-direction: column; gap: 0.1rem; }
    
    .app-title {
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
      text-shadow: 0 2px 10px rgba(102, 197, 165, 0.3);
    }

    .app-subtitle { font-size: 0.85rem; color: var(--text-main); opacity: 0.9; }

    .header-controls { display: flex; align-items: center; flex-wrap: wrap; gap: 0.6rem; }

    .date-block label { font-size: 0.78rem; color: var(--text-main); opacity: 0.9; }

    #date-input {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(0, 0, 0, 0.3);
      border-radius: 999px;
      padding: 0.35rem 0.7rem;
      color: var(--text-main);
      font-size: 0.9rem;
      min-width: 150px;
      font-family: inherit;
    }
    #date-input:focus { outline: 1px solid var(--accent-gold); border-color: var(--accent-gold); }

    .xp-pill {
      background: var(--accent-gold-soft);
      color: var(--accent-gold-strong);
      border-radius: 999px;
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      border: 1px solid rgba(245, 193, 92, 0.6);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
    }
    .xp-pill span { font-weight: 600; }

    /* SUMMARY BAR */
    .summary-bar {
      background: rgba(6, 19, 13, 0.9);
      border-radius: 12px;
      padding: 0.4rem 0.7rem;
      border: 1px solid rgba(0, 0, 0, 0.35);
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.6rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
    }

    @media (max-width: 900px) {
      .summary-bar { grid-template-columns: minmax(0, 1fr); }
      .summary-actions { justify-content: flex-start; }
    }

    .summary-main { font-size: 0.9rem; display: flex; flex-direction: column; gap: 0.15rem; }
    .summary-main-top { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .summary-main strong { font-size: 1rem; }
    #total-xp { font-weight: 500; }
    .day-rating { font-size: 0.85rem; }

    .badge { display: inline-block; padding: 0.1rem 0.6rem; border-radius: 999px; font-size: 0.78rem; margin-left: 0.2rem; }
    .elite { background: rgba(22, 163, 74, 0.22); color: #6ee7b7; border: 1px solid #16a34a; }
    .strong { background: rgba(37, 99, 235, 0.18); color: #93c5fd; border: 1px solid #2563eb; }
    .survival { background: rgba(234, 179, 8, 0.18); color: #fde68a; border: 1px solid #eab308; }
    .red { background: rgba(248, 113, 113, 0.2); color: #fecaca; border: 1px solid #ef4444; }

    .streak-chips { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: 0.05rem; }
    .streak-chip {
      background: rgba(10, 32, 22, 0.9);
      border-radius: 999px;
      padding: 0.12rem 0.55rem;
      font-size: 0.76rem;
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .streak-chip strong { color: var(--accent-gold-strong); font-weight: 600; }

    .summary-actions { display: flex; justify-content: flex-end; gap: 0.4rem; flex-wrap: wrap; }

    button {
      background: var(--accent-gold);
      color: #1f2933;
      border: none;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      white-space: nowrap;
      transition: all 0.15s;
    }
    button:hover { filter: brightness(1.1); transform: translateY(-1px); }
    button:active { transform: scale(0.97); }
    button.secondary { background: transparent; border: 1px solid rgba(148, 163, 184, 0.6); color: var(--text-main); }
    button.icon-btn { padding: 0.35rem 0.5rem; min-width: 32px; justify-content: center;}

    /* MAIN GRID */
    main {
      max-height: calc(100vh - 160px);
      overflow-y: auto;
      padding-right: 0.15rem;
      scrollbar-width: thin;
      scrollbar-color: var(--border-subtle) var(--bg-forest);
    }
    main::-webkit-scrollbar { width: 6px; }
    main::-webkit-scrollbar-track { background: var(--bg-forest); }
    main::-webkit-scrollbar-thumb { background-color: var(--border-subtle); border-radius: 20px; }

    .sections { display: flex; flex-direction: column; gap: 0.55rem; padding-bottom: 0.5rem; }
    .section-block { background: transparent; }
    .section-title {
      font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.16em;
      color: rgba(245, 247, 244, 0.8); margin: 0 0 0.2rem;
    }

    .section-grid-3 { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 0.45rem; }
    .section-grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.45rem; }
    .section-grid-1 { display: grid; grid-template-columns: minmax(0, 1fr); gap: 0.45rem; }

    @media (max-width: 1024px) { .section-grid-3 { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (max-width: 768px) {
      body { padding: 0.5rem; }
      .container { max-width: 100%; }
      main { max-height: none; overflow-y: visible; }
      .section-grid-3, .section-grid-2 { grid-template-columns: minmax(0, 1fr); }
      .card { padding: 0.55rem 0.6rem; min-height: auto; }
      .items { grid-template-columns: minmax(0, 1fr); }
    }

    /* CARDS */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 0.6rem 0.7rem;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      display: flex; flex-direction: column; gap: 0.25rem;
      min-height: 130px;
      transition: border-color 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    .card:hover { border-color: rgba(255,255,255,0.1); }
    .card[data-category="mastery"], .card[data-category="responsibility"] {
      padding-top: 0.5rem; padding-bottom: 0.5rem; min-height: 115px;
    }

    .card-header { display: flex; justify-content: space-between; align-items: center; gap: 0.4rem; margin-bottom: 0.1rem; position: relative; z-index: 1; }
    .card-title-block { display: flex; flex-direction: column; gap: 0.05rem; }
    .card-title { font-size: 0.98rem; font-weight: 600; }
    .card-subtitle { font-size: 0.78rem; color: var(--text-muted); }
    .xp { font-weight: 600; font-size: 0.8rem; opacity: 0.95; color: var(--accent-gold-strong); white-space: nowrap; }

    /* Progress Bar */
    .progress-track { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(0,0,0,0.3); }
    .progress-fill {
      height: 100%; background: var(--komorebi-mint); width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 0.4s ease;
    }
    .progress-fill.maxed { background: var(--accent-gold); box-shadow: 0 0 10px var(--accent-gold); }

    .prompt-body { font-size: 0.9rem; color: var(--text-muted); line-height: 1.4; font-style: italic; }

    .items { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.18rem 0.7rem; font-size: 0.9rem; position: relative; z-index: 1; }
    .items-wide { grid-template-columns: minmax(0, 1fr); }
    @media (max-width: 640px) { .items { grid-template-columns: minmax(0, 1fr); } }

    label { display: flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.9rem; user-select: none; transition: color 0.2s; }
    label:hover { color: var(--komorebi-mint-soft); }
    input[type="checkbox"] { transform: scale(1.2); accent-color: var(--accent-gold); cursor: pointer; }

    details.details-list { margin-top: 0.1rem; font-size: 0.8rem; color: var(--text-muted); }
    details.details-list summary { cursor: pointer; list-style: none; outline: none; }
    details.details-list summary::-webkit-details-marker { display: none; }
    details.details-list summary::before { content: "‚ñ∏"; display: inline-block; margin-right: 0.2rem; font-size: 0.7rem; transform: translateY(-1px); }
    details.details-list[open] summary::before { content: "‚ñæ"; }
    .sub-list { margin: 0.15rem 0 0; padding-left: 1.1rem; font-size: 0.8rem; color: var(--text-muted); max-height: 120px; overflow-y: auto; }
    .sub-list li { margin: 0.05rem 0; }

    /* NOTE AREA */
    .note-area-container { margin-top: 0.5rem; }
    .note-area {
      width: 100%; height: 80px; background: rgba(0,0,0,0.2);
      border: 1px solid var(--border-subtle); border-radius: 8px;
      color: var(--text-main); font-family: inherit; padding: 0.5rem;
      resize: vertical; font-size: 0.9rem;
    }
    .note-area:focus { outline: 1px solid var(--accent-gold); border-color: var(--accent-gold); }

    /* MODAL GENERAL */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); z-index: 50;
      display: none; justify-content: center; align-items: center;
      backdrop-filter: blur(6px);
    }
    .modal-content {
      background: var(--card); padding: 1.5rem; border-radius: 12px;
      border: 1px solid var(--accent-gold); max-width: 500px; width: 90%;
      max-height: 80vh; overflow-y: auto;
    }
    .modal-title { font-size: 1.2rem; margin-bottom: 1rem; color: var(--accent-gold); display: flex; justify-content: space-between; align-items: center;}
    .modal-actions { display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end; }
    textarea.data-area {
      width: 100%; height: 100px; background: rgba(0,0,0,0.3);
      border: 1px solid var(--border-subtle); color: var(--text-muted);
      font-family: monospace; font-size: 0.8rem; padding: 0.5rem;
      border-radius: 6px;
    }

    /* LIBRARY MODAL STYLES */
    .library-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-subtle); padding-bottom: 0.5rem; }
    .library-tab { cursor: pointer; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem; color: var(--text-muted); }
    .library-tab.active { background: var(--komorebi-mint); color: #000; font-weight: 600; }
    
    .search-bar { width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-subtle); background: rgba(0,0,0,0.3); color: var(--text-main); margin-bottom: 1rem; }
    
    .library-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .library-item { background: rgba(255,255,255,0.03); padding: 0.6rem; border-radius: 6px; border: 1px solid transparent; }
    .library-item:hover { border-color: var(--komorebi-mint-soft); }
    .lib-title { font-weight: 600; color: var(--komorebi-mint); font-size: 0.9rem; margin-bottom: 0.2rem; }
    .lib-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.3; }

    /* CHART STYLES */
    .chart-container {
        display: flex; align-items: flex-end; justify-content: space-between;
        height: 200px; margin-top: 1rem; padding-bottom: 5px;
        border-bottom: 1px solid var(--text-muted);
        gap: 4px;
    }
    .bar-group { display: flex; flex-direction: column; align-items: center; flex: 1; }
    .bar { width: 80%; background: var(--komorebi-mint); border-radius: 4px 4px 0 0; transition: height 0.5s ease; min-height: 2px; position: relative; }
    .bar.elite { background: #4ade80; box-shadow: 0 0 8px rgba(74, 222, 128, 0.4); }
    .bar.strong { background: #60a5fa; }
    .bar.survival { background: #fbbf24; }
    .bar-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }
    .bar-value { font-size: 0.65rem; color: #fff; margin-bottom: 2px; }

    /* INVESTOR CARD */
    .investor-card-content { display: flex; flex-direction: column; gap: 0.2rem; }
    .investor-name { color: var(--komorebi-mint); font-weight: 700; font-size: 1rem; }
    .investor-resource { color: var(--text-main); font-style: italic; }
    .investor-stats { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; display: flex; gap: 0.5rem; align-items: center; }
    .investor-stats span { background: rgba(255,255,255,0.1); padding: 0.1rem 0.4rem; border-radius: 4px; }

    /* GAMIFICATION ANIMATION */
    .floating-xp {
        position: fixed; color: var(--accent-gold); font-weight: bold; font-size: 1rem;
        pointer-events: none; animation: floatUp 1s ease-out forwards; z-index: 9999;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-40px) scale(1.2); } }

    #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
  </style>
</head>
<body>
  <canvas id="confetti-canvas"></canvas>

  <div class="container">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-top">
        <div class="app-title-block">
          <div class="app-title">Komorebi OS</div>
          <div class="app-subtitle">Master Protocol (Mind + Body + Legacy)</div>
        </div>
        <div class="header-controls">
          <div class="date-block">
            <label for="date-input">Protocol Date</label><br />
            <input type="date" id="date-input" />
          </div>
          <div class="xp-pill">
            <span id="xp-pill-value">0</span> XP
          </div>
        </div>
      </div>
    </header>

    <!-- SUMMARY BAR -->
    <section class="summary-bar">
      <div class="summary-main">
        <div class="summary-main-top">
          <div id="total-xp">Total XP: 0 / 9000</div>
          <div class="day-rating" id="day-rating">Day Rating: <span class="badge red">Red Zone</span></div>
        </div>
        <div class="streak-chips" id="streak-chips"></div>
      </div>
      <div class="summary-actions">
        <button id="save-day">Save Day</button>
        <button id="library-btn" class="secondary icon-btn" title="Knowledge Library">üìñ</button>
        <button id="stats-btn" class="secondary icon-btn" title="View Stats">üìä</button>
        <button id="settings-btn" class="secondary icon-btn" title="Data Settings">‚öôÔ∏è</button>
        <button id="reset-day" class="secondary icon-btn" title="Clear today">‚Ü∫</button>
      </div>
    </section>

    <!-- DAILY PROMPTS -->
    <section class="section-block">
      <h2 class="section-title">Daily Alignment</h2>
      <div class="section-grid-2">
        <div class="card">
          <div class="card-header"><div class="card-title">Mental Model</div></div>
          <div class="prompt-body" id="prompt-mental-model">Loading...</div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Productivity Game</div></div>
          <div class="prompt-body" id="prompt-productivity">Loading...</div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Wisdom</div></div>
          <div class="prompt-body" id="prompt-quote">Loading...</div>
        </div>
        
        <!-- INVESTOR OF THE WEEK -->
        <div class="card" style="border-color: var(--komorebi-mint-soft);">
          <div class="card-header">
              <div class="card-title-block">
                <div class="card-title">Investor of the Week</div>
                <div class="card-subtitle">Weekly Deep Dive</div>
              </div>
              <div class="xp">Weekly</div>
          </div>
          <div class="prompt-body investor-card-content">
              <div id="investor-name" class="investor-name">Loading...</div>
              <div id="investor-resource" class="investor-resource">...</div>
              <div id="investor-stats" class="investor-stats"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MAIN GRID -->
    <main>
      <div class="sections">

        <!-- HEALTH -->
        <section class="section-block">
          <h2 class="section-title">Health (Body Fat &lt; 16%)</h2>
          <div class="section-grid-3">
            <div class="card" data-category="supplements">
              <div class="card-header"><div class="card-title">Jaguar Fuel</div><div class="xp">0 / 500 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items items-wide">
                <label><input type="checkbox" data-key="supplementStack" />Smoothie & Supps</label>
                <details class="details-list"><summary>Stack Details</summary>
                  <ul class="sub-list">
                      <li>Clean Protein 35g, Creatine, Greens</li>
                      <li>Alpha GPC, Omega 3, Flexi-Calcium</li>
                      <li>Dutasteride/Minoxidil, Joint Complex</li>
                      <li>Hydration: 2L + Slow-Mag/Electrolytes</li>
                  </ul>
                </details>
              </div>
            </div>

            <div class="card" data-category="fitness">
              <div class="card-header"><div class="card-title">Jaguar Physique</div><div class="xp">0 / 1000 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items">
                <label><input type="checkbox" data-key="workout" />Workout (Huberman/Johnson)</label>
                <label><input type="checkbox" data-key="corrective" />Corrective/Postural (10m)</label>
                <label><input type="checkbox" data-key="zone2" />Zone 2 / Ruck</label>
              </div>
            </div>
             <div class="card" data-category="aesthetics">
              <div class="card-header"><div class="card-title">Aesthetics</div><div class="xp">0 / 500 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items">
                <label><input type="checkbox" data-key="grooming" />Grooming/Skin</label>
                <label><input type="checkbox" data-key="posture" />Posture Wall Sits</label>
                <label><input type="checkbox" data-key="guaSha" />Gua Sha / Ice Roll</label>
              </div>
            </div>
          </div>

          <div class="section-grid-1" style="margin-top: 0.4rem;">
            <div class="card workout-card">
              <div class="card-header">
                <div class="card-title-block"><div class="card-title">Workout Focus</div><div class="card-subtitle" id="wod-type">Loading‚Ä¶</div></div>
              </div>
              <div class="items items-wide"><ul class="sub-list" id="wod-details"></ul></div>
            </div>
          </div>
        </section>

        <!-- MIND & MEANING -->
        <section class="section-block">
          <h2 class="section-title">Mind & Meaning</h2>
          <div class="section-grid-3">
            <div class="card" data-category="wisdom">
              <div class="card-header"><div class="card-title">Mental Resilience</div><div class="xp">0 / 1000 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items">
                <label><input type="checkbox" data-key="meditate" />FitMind / Meditation</label>
                <label><input type="checkbox" data-key="slowThink" />Slow Thinking (10m Solitude)</label>
                <label><input type="checkbox" data-key="gratitude" />Evening Gratitude</label>
                <label><input type="checkbox" data-key="stoicReflect" />Stoic Reflection</label>
              </div>
            </div>

            <div class="card" data-category="values">
              <div class="card-header"><div class="card-title">Core Values</div><div class="xp">0 / 1000 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items">
                <label><input type="checkbox" data-key="valStrength" />Strength</label>
                <label><input type="checkbox" data-key="valBeauty" />Beauty</label>
                <label><input type="checkbox" data-key="valService" />Service</label>
                <label><input type="checkbox" data-key="valFamily" />Family</label>
                <label><input type="checkbox" data-key="valWisdom" />Wisdom</label>
              </div>
            </div>
             <div class="card" data-category="arete">
              <div class="card-header"><div class="card-title">Anti-Mimetic</div><div class="xp">0 / 500 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items items-wide">
                 <label><input type="checkbox" data-key="antiMimetic" />Avoided "The Crowd"</label>
                 <label><input type="checkbox" data-key="legacy" />Legacy Action (Build for future)</label>
              </div>
            </div>
          </div>
        </section>

        <!-- LEARNING & SYSTEM -->
        <section class="section-block">
          <h2 class="section-title">Learning & Productivity</h2>
          <div class="section-grid-2">
            <div class="card" data-category="mastery">
              <div class="card-header"><div class="card-title">Ultralearning</div><div class="xp">0 / 2000 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items">
                <label><input type="checkbox" data-key="metalearning" />Metalearning Map</label>
                <label><input type="checkbox" data-key="drill" />Drill Weaknesses</label>
                <label><input type="checkbox" data-key="overlearn" />Overlearn/Teach</label>
              </div>
            </div>

            <div class="card" data-category="responsibility">
              <div class="card-header"><div class="card-title">Second Brain</div><div class="xp">0 / 2000 XP</div></div>
              <div class="progress-track"><div class="progress-fill"></div></div>
              <div class="items">
                <label><input type="checkbox" data-key="sbCapture" />Capture (Notes/Ideas)</label>
                <label><input type="checkbox" data-key="sbOrganize" />Organize (PARA)</label>
                <label><input type="checkbox" data-key="sbDistill" />Distill (Progressive Sum.)</label>
              </div>
            </div>
          </div>
        </section>

        <!-- DAILY NOTE -->
        <section class="section-block">
            <div class="card">
                <div class="card-header"><div class="card-title">Daily Journal</div></div>
                <div class="note-area-container">
                    <textarea id="daily-note" class="note-area" placeholder="Wins, lessons, or 'One thing I learned'..."></textarea>
                </div>
            </div>
        </section>

      </div>
    </main>
  </div>

  <!-- LIBRARY MODAL -->
  <div class="modal-overlay" id="library-modal">
      <div class="modal-content" style="max-width: 700px;">
          <h3 class="modal-title">Knowledge Library <span id="close-lib-modal" style="cursor:pointer">‚úï</span></h3>
          
          <div class="library-tabs">
              <div class="library-tab active" onclick="switchLibTab('models')">Mental Models</div>
              <div class="library-tab" onclick="switchLibTab('productivity')">Productivity</div>
              <div class="library-tab" onclick="switchLibTab('investors')">Investors</div>
              <div class="library-tab" onclick="switchLibTab('quotes')">Quotes</div>
          </div>

          <input type="text" id="lib-search" class="search-bar" placeholder="Search the archives..." onkeyup="filterLibrary()">
          
          <div class="library-list" id="library-content">
              <!-- Content injected via JS -->
          </div>
      </div>
  </div>

  <!-- DATA SETTINGS MODAL -->
  <div class="modal-overlay" id="data-modal">
    <div class="modal-content">
      <h3 class="modal-title">Data Management <span id="close-data-modal" style="cursor:pointer">‚úï</span></h3>
      <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.5rem;">
        Backup your data or restore from a previous save.
      </p>
      <textarea id="export-area" class="data-area"></textarea>
      <div class="modal-actions">
        <button id="restore-btn">Restore</button>
      </div>
    </div>
  </div>

  <!-- STATS MODAL -->
  <div class="modal-overlay" id="stats-modal">
    <div class="modal-content" style="max-width: 600px;">
      <h3 class="modal-title">Last 7 Days <span id="close-stats-modal" style="cursor:pointer">‚úï</span></h3>
      <div class="chart-container" id="stats-chart">
        <!-- Bars injected via JS -->
      </div>
    </div>
  </div>

  <script>
    // --- DATA & CONFIG ---
    const CONSTANTS = {
      MAX_XP: 9000,
      XP_LEVELS: { ELITE: 6500, STRONG: 5000, SURVIVAL: 3500 },
      CATEGORY_MAX: {
        supplements: 500, smoothie: 500, fitness: 1000, wisdom: 1000, aesthetics: 500,
        mastery: 2000, responsibility: 2000, arete: 500, values: 1000
      }
    };

    // --- LARGE DATABASES ---

    const DB_MODELS = [
        { name: "First Principles", desc: "Reduce problems to fundamental truths, build upward." },
        { name: "Second-Order Thinking", desc: "Consider consequences beyond the immediate." },
        { name: "Inversion", desc: "Think backward: how could this fail? Then avoid it." },
        { name: "Probabilistic Thinking", desc: "Evaluate decisions using likelihoods, not certainties." },
        { name: "Bayesian Updating", desc: "Adjust beliefs in light of new evidence." },
        { name: "Expected Value", desc: "Quantify decisions: outcomes √ó probabilities." },
        { name: "Circle of Competence", desc: "Operate within your area of true knowledge." },
        { name: "Falsifiability (Popper)", desc: "If it cannot be proven wrong, it‚Äôs not knowledge." },
        { name: "Map ‚â† Territory", desc: "Symbols are not reality." },
        { name: "Occam‚Äôs Razor", desc: "Prefer the simplest explanation that fits the data." },
        { name: "Hanlon‚Äôs Razor", desc: "Never attribute to malice what can be explained by stupidity." },
        { name: "Necessity & Sufficiency", desc: "Distinguish causes from catalysts." },
        { name: "Thought Experiments", desc: "Simulate reality to explore principles." },
        { name: "Decision Trees", desc: "Branching paths for multi-stage decisions." },
        { name: "Sensitivity Analysis", desc: "Test assumptions to see what breaks the model." },
        { name: "Kelly Criterion", desc: "Optimal bet sizing under uncertainty." },
        { name: "Barbell Strategy", desc: "Pair extreme safety with high-upside risk." },
        { name: "Anti-fragility (Taleb)", desc: "Seek systems that benefit from disorder." },
        { name: "Via Negativa", desc: "What not to do is often more important than what to do." },
        { name: "Mimetic Desire (Girard)", desc: "We imitate others' desires; conflict follows." },
        { name: "Status Games", desc: "Most ambition is about pecking order. Avoid them." },
        { name: "Envy & Jealousy", desc: "Underrated forces behind irrational decisions." },
        { name: "Social Proof", desc: "We copy others, especially under uncertainty." },
        { name: "Confirmation Bias", desc: "We seek agreement, not truth." },
        { name: "Survivorship Bias", desc: "We forget the invisible failures." },
        { name: "Do-Something Syndrome", desc: "Action bias overrides logic." },
        { name: "Pavlovian Association", desc: "Emotionally charged cues override reason." },
        { name: "Availability Heuristic", desc: "Recent, vivid = true (but not really)." },
        { name: "OODA Loop (Boyd)", desc: "Observe, Orient, Decide, Act." },
        { name: "Asymmetric Warfare", desc: "Win by not fighting on equal terms." },
        { name: "Concentration of Force", desc: "Overwhelm by focus." },
        { name: "The Lindy Effect", desc: "What survives ages, survives longer." },
        { name: "Pareto Principle", desc: "80% of effects come from 20% of causes." }
    ];

    const DB_PRODUCTIVITY = [
        { name: "5 Second Rule (Mel Robbins)", desc: "Count 5-4-3-2-1-GO to bypass hesitation." },
        { name: "Eat That Frog (Brian Tracy)", desc: "Do the biggest, ugliest task first thing." },
        { name: "2-Minute Rule (James Clear)", desc: "If it takes < 2 mins, do it now. Start habits by doing just 2 mins." },
        { name: "Time Boxing (Nir Eyal)", desc: "Schedule every minute of your day. 'Indistractable'." },
        { name: "WOOP (Gabriele Oettingen)", desc: "Wish, Outcome, Obstacle, Plan." },
        { name: "Ivy Lee Method", desc: "Define your 3 & 1 priorities the night before." },
        { name: "Reversal of Desire (The Tools)", desc: "Scream 'Bring it on!' when facing pain." },
        { name: "Intermittent Sobriety", desc: "Abstain from high-dopamine inputs to reset (Dopamine Nation)." },
        { name: "Batching Buckets (GTD)", desc: "Group similar tasks (calls, emails) to reduce context switching." },
        { name: "Pomodoro Technique", desc: "25 min focus, 5 min diffuse mode to learn complex topics." },
        { name: "Checklist Manifesto", desc: "Use checklists to prevent stupid mistakes." },
        { name: "Deep Work (Cal Newport)", desc: "Dedicate blocks of time to distraction-free cognitive work." },
        { name: "Flow (Csikszentmihalyi)", desc: "Balance challenge and skill to enter the zone." },
        { name: "The One Thing", desc: "What is the one thing such that by doing it, everything else is easier or unnecessary?" },
        { name: "Essentialism", desc: "Less but better. The disciplined pursuit of less." },
        { name: "Tiny Habits (BJ Fogg)", desc: "Anchor a tiny behavior to an existing trigger." },
        { name: "Bullet Journal", desc: "Rapid logging of tasks, events, and notes." },
        { name: "Blue Ocean Strategy", desc: "Don't compete. Create a new market." },
        { name: "Minimum Viable Product (Ries)", desc: "Build the smallest thing to test assumptions." }
    ];

    const DB_INVESTORS = [
        { name: "Stanley Druckenmiller", resource: "The Genius of Stan Druckenmiller (MOI Global)", years: "30 Years" },
        { name: "Mark Leonard", resource: "Constellation Shareholder Letters / Q&A", years: "25 Years" },
        { name: "Warren Buffett", resource: "Berkshire Shareholder Letters (1965-2023)", years: "55 Years" },
        { name: "Charlie Munger", resource: "Poor Charlie's Almanack & Transcripts", years: "15+ Years" },
        { name: "Seth Klarman", resource: "Margin of Safety & Baupost Letters", years: "25 Years" },
        { name: "Rakesh Jhunjhunwala", resource: "The Big Bull of India (Insights & PDFs)", years: "35 Years" },
        { name: "Peter Lynch", resource: "One Up on Wall Street", years: "15 Years" },
        { name: "Nick Sleep", resource: "Nomad Investment Partnership Letters", years: "13 Years" },
        { name: "Li Lu", resource: "Himalayan Capital / Modernization", years: "20+ Years" },
        { name: "Howard Marks", resource: "The Most Important Thing / Memos", years: "25+ Years" },
        { name: "Joel Greenblatt", resource: "The Little Book that Beats the Market / Class Notes", years: "20 Years" },
        { name: "George Soros", resource: "The Alchemy of Finance", years: "35 Years" },
        { name: "Benjamin Graham", resource: "The Intelligent Investor / Security Analysis", years: "25 Years" },
        { name: "Philip Fisher", resource: "Common Stocks and Uncommon Profits", years: "70 Years" },
        { name: "Terry Smith", resource: "Investing for Growth / Fundsmith Letters", years: "20+ Years" },
        { name: "Bill Ackman", resource: "Pershing Square Letters & Activist Campaigns", years: "20 Years" },
        { name: "Chuck Akre", resource: "Akre Capital Management Letters (The Three-Legged Stool)", years: "30 Years" },
        { name: "John Templeton", resource: "Templeton Growth Fund", years: "40 Years" },
        { name: "Walter Schloss", resource: "Factors Needed to Make Money in the Stock Market", years: "50 Years" },
        { name: "Mohnish Pabrai", resource: "The Dhandho Investor", years: "20 Years" },
        { name: "Michael Mauboussin", resource: "More Than You Know / Consilient Observer", years: "Strategy" },
        { name: "Ray Dalio", resource: "Principles / Bridgewater Daily Observations", years: "40 Years" },
        { name: "Jamie Dimon", resource: "JPMorgan Chase Shareholder Letters", years: "20 Years" },
        { name: "Bruce Greenwald", resource: "Class Notes & Value Investing: From Graham to Buffett", years: "Academic" }
    ];

    const DB_QUOTES = [
        "‚ÄúDiscipline equals freedom.‚Äù ‚Äî Jocko Willink",
        "‚ÄúThe impediment to action advances action.‚Äù ‚Äî Marcus Aurelius",
        "‚ÄúYou do not rise to the level of your goals. You fall to the level of your systems.‚Äù ‚Äî James Clear",
        "‚ÄúThe score takes care of itself.‚Äù ‚Äî Bill Walsh",
        "‚ÄúHe who has a why to live can bear almost any how.‚Äù ‚Äî Nietzsche",
        "‚ÄúBe the person with embarrassing goals and impressive results.‚Äù ‚Äî Stephen Guise",
        "‚ÄúAction isn't just the effect of motivation; it's also the cause of it.‚Äù ‚Äî Mark Manson",
        "‚ÄúGive me a lever long enough and a fulcrum on which to place it, and I shall move the world.‚Äù ‚Äî Archimedes",
        "‚ÄúWhat you do is what matters, not what you think or say or plan.‚Äù ‚Äî Jason Fried",
        "‚ÄúIt is the quality of time at work that counts and the quantity of time at home that matters.‚Äù ‚Äî Brian Tracy",
        "‚ÄúI am the master of my fate, I am the captain of my soul.‚Äù ‚Äî Invictus",
        "‚ÄúWe suffer more in imagination than in reality.‚Äù ‚Äî Seneca",
        "‚ÄúIf you want to go fast, go alone. If you want to go far, go together.‚Äù ‚Äî African Proverb",
        "‚ÄúIt is not the critic who counts... The credit belongs to the man who is actually in the arena.‚Äù ‚Äî Theodore Roosevelt",
        "‚ÄúEverything in life is a mind game!‚Äù ‚Äî David Goggins",
        "‚ÄúSlow is smooth, smooth is fast.‚Äù ‚Äî Navy SEALs",
        "‚ÄúInvert, always invert.‚Äù ‚Äî Jacobi",
        "‚ÄúI want to be able to look back and say, ‚ÄòI didn‚Äôt solve everything, but I didn‚Äôt create any new problems.‚Äô‚Äù ‚Äî Naval Ravikant"
    ];

    const els = {
      dateInput: document.getElementById('date-input'),
      totalXp: document.getElementById('total-xp'),
      dayRating: document.getElementById('day-rating'),
      saveBtn: document.getElementById('save-day'),
      resetBtn: document.getElementById('reset-day'),
      settingsBtn: document.getElementById('settings-btn'),
      statsBtn: document.getElementById('stats-btn'),
      libraryBtn: document.getElementById('library-btn'),
      streakChips: document.getElementById('streak-chips'),
      xpPillValue: document.getElementById('xp-pill-value'),
      wodType: document.getElementById('wod-type'),
      wodDetails: document.getElementById('wod-details'),
      dailyNote: document.getElementById('daily-note'),
      prompts: {
        model: document.getElementById('prompt-mental-model'),
        game: document.getElementById('prompt-productivity'),
        quote: document.getElementById('prompt-quote')
      },
      investorCard: {
        name: document.getElementById('investor-name'),
        resource: document.getElementById('investor-resource'),
        stats: document.getElementById('investor-stats')
      },
      modals: {
        data: document.getElementById('data-modal'),
        stats: document.getElementById('stats-modal'),
        library: document.getElementById('library-modal')
      }
    };

    let previousXP = 0; // Track for animation
    let currentLibTab = 'models'; // For library viewing

    // --- UTILITIES ---
    function getTodayISO() { return new Date().toISOString().slice(0, 10); }
    function formatDateKey(date) { return `arete_xp_${date}`; }
    
    // Random index based on day string (changes daily)
    function getPseudoRandomIndex(seedStr, len) {
      let hash = 0;
      for (let i = 0; i < seedStr.length; i++) {
        hash = ((hash << 5) - hash) + seedStr.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash) % len;
    }

    // Week number for Investor rotation (Changes weekly)
    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
    }

    // --- CORE LOGIC ---
    function getCheckboxes() { return Array.from(document.querySelectorAll('input[type="checkbox"][data-key]')); }

    function readState() {
      const state = {};
      getCheckboxes().forEach(cb => state[cb.dataset.key] = cb.checked);
      state.note = els.dailyNote.value; // Save note
      return state;
    }

    function writeState(state) {
      getCheckboxes().forEach(cb => cb.checked = !!state[cb.dataset.key]);
      els.dailyNote.value = state.note || "";
    }

    function calculateXP(state) {
      const xp = { supplements: 0, smoothie: 0, fitness: 0, wisdom: 0, aesthetics: 0, mastery: 0, responsibility: 0, arete: 0, values: 0 };

      if (state.supplementStack) xp.supplements = 500;
      if (state.smoothie) xp.smoothie = 500;

      // Fitness
      const fKeys = ['workout', 'corrective', 'zone2'];
      const fCount = fKeys.filter(k => state[k]).length;
      if (fCount === 3) xp.fitness = 1000; else if (fCount >= 1) xp.fitness = 333 * fCount;

      // Aesthetics
      const aeKeys = ['grooming', 'posture', 'guaSha'];
      const aeCount = aeKeys.filter(k => state[k]).length;
      if(aeCount === 3) xp.aesthetics = 500; else if (aeCount > 0) xp.aesthetics = 150 * aeCount;

      // Wisdom
      const wKeys = ['meditate', 'slowThink', 'gratitude', 'stoicReflect'];
      const wCount = wKeys.filter(k => state[k]).length;
      if (wCount === 4) xp.wisdom = 1000; else if (wCount > 0) xp.wisdom = 250 * wCount;

      // Mastery
      const mKeys = ['metalearning', 'drill', 'overlearn'];
      const mCount = mKeys.filter(k => state[k]).length;
      if (mCount === 3) xp.mastery = 2000; else if (mCount > 0) xp.mastery = 650 * mCount;
      
      // Responsibility
      const rKeys = ['sbCapture', 'sbOrganize', 'sbDistill'];
      const rCount = rKeys.filter(k => state[k]).length;
      if (rCount === 3) xp.responsibility = 2000; else if (rCount > 0) xp.responsibility = 650 * rCount;

      // Arete
      const aKeys = ['antiMimetic', 'legacy'];
      const aCount = aKeys.filter(k => state[k]).length;
      if (aCount > 0) xp.arete = 250 * aCount;

      // Values
      const vCount = ['valStrength', 'valBeauty', 'valService', 'valFamily', 'valWisdom'].filter(k => state[k]).length;
      if (vCount >= 5) xp.values = 1000; else if (vCount > 0) xp.values = 200 * vCount;

      return xp;
    }

    // --- UI & ANIMATION ---
    function showFloatingXP(x, y, amount) {
        if (amount <= 0) return;
        const el = document.createElement('div');
        el.classList.add('floating-xp');
        el.innerText = `+${amount} XP`;
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    function handleCheck(e) {
        const state = readState();
        const currentXPObj = calculateXP(state);
        const currentTotal = Object.values(currentXPObj).reduce((a, b) => a + b, 0);
        
        if (e.target.checked && currentTotal > previousXP) {
            showFloatingXP(e.clientX, e.clientY, currentTotal - previousXP);
        }
        updateVisuals();
    }

    function updateDynamicContent(dateStr) {
      const idxModel = getPseudoRandomIndex(dateStr + 'model', DB_MODELS.length);
      const idxGame = getPseudoRandomIndex(dateStr + 'game', DB_PRODUCTIVITY.length);
      const idxQuote = getPseudoRandomIndex(dateStr + 'quote', DB_QUOTES.length);
      
      els.prompts.model.textContent = DB_MODELS[idxModel].name + ": " + DB_MODELS[idxModel].desc;
      els.prompts.game.textContent = DB_PRODUCTIVITY[idxGame].name + ": " + DB_PRODUCTIVITY[idxGame].desc;
      els.prompts.quote.textContent = DB_QUOTES[idxQuote];

      // Update Investor of the Week (Based on Week Number)
      const dateObj = new Date(dateStr);
      const weekNum = getWeekNumber(dateObj);
      const investorIdx = weekNum % DB_INVESTORS.length;
      const investor = DB_INVESTORS[investorIdx];

      els.investorCard.name.textContent = investor.name;
      els.investorCard.resource.textContent = investor.resource;
      els.investorCard.stats.innerHTML = `<span>${investor.years}</span>`;

      // Workout Logic (Jaguar Protocol)
      const dayOfWeek = dateObj.getDay(); // 0=Sun, 1=Mon
      const workouts = [
          { t: "Endurance/Cardio", d: ["Swim, Hike, or Long Zone 2", "Recovery stretch"] }, // Sun
          { t: "Lower Body Strength", d: ["Squat/Deadlift alternatives", "Posterior chain", "Calves"] }, // Mon
          { t: "Sauna + Cold Exposure", d: ["3-5 rounds", "20 min sauna + 5 min cold"] }, // Tue
          { t: "Upper Body Strength", d: ["Push/pull", "Delts, Rhomboids, Neck"] }, // Wed
          { t: "Cardio Endurance", d: ["Row/Ski/Run/Bike circuit", "Or Ruck"] }, // Thu
          { t: "HIIT", d: ["Bike, Row, Sled, KB Swings", "No burpees"] }, // Fri
          { t: "Hypertrophy Circuits", d: ["Arms", "Core", "Calves", "Neck"] } // Sat
      ];
      
      const w = workouts[dayOfWeek];
      els.wodType.textContent = w.t;
      els.wodDetails.innerHTML = w.d.map(d => `<li>${d}</li>`).join('');
    }

    function updateVisuals() {
      const state = readState();
      const xp = calculateXP(state);
      const total = Object.values(xp).reduce((a, b) => a + b, 0);
      previousXP = total;

      document.querySelectorAll('.card').forEach(card => {
        const cat = card.dataset.category;
        if (!cat || !CONSTANTS.CATEGORY_MAX[cat]) return;
        const current = xp[cat];
        const max = CONSTANTS.CATEGORY_MAX[cat];
        
        const xpEl = card.querySelector('.xp');
        if (xpEl) xpEl.textContent = `${current} / ${max} XP`;
        const fillEl = card.querySelector('.progress-fill');
        if (fillEl) {
            const pct = Math.min(100, (current / max) * 100);
            fillEl.style.width = `${pct}%`;
            if (pct >= 100) fillEl.classList.add('maxed'); else fillEl.classList.remove('maxed');
        }
      });

      els.totalXp.textContent = `Total XP: ${total} / ${CONSTANTS.MAX_XP}`;
      els.xpPillValue.textContent = total;
      
      let rLabel = 'Red Zone', rClass = 'red';
      if (total >= CONSTANTS.XP_LEVELS.ELITE) { rLabel = 'Jaguar King'; rClass = 'elite'; }
      else if (total >= CONSTANTS.XP_LEVELS.STRONG) { rLabel = 'Warrior'; rClass = 'strong'; }
      else if (total >= CONSTANTS.XP_LEVELS.SURVIVAL) { rLabel = 'Survival'; rClass = 'survival'; }
      
      els.dayRating.innerHTML = `Day Rating: <span class="badge ${rClass}">${rLabel}</span>`;
      return total;
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const pieces = Array.from({length: 100}).map(() => ({
            x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height,
            c: ['#66c5a5', '#f5c15c', '#ffffff'][Math.floor(Math.random()*3)], s: Math.random()*5+2, d: Math.random()*5+2
        }));
        let frame = 0;
        function loop() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            let active = false;
            pieces.forEach(p => {
                p.y += p.d; p.x += Math.sin(frame/20);
                if (p.y < canvas.height) active = true;
                ctx.fillStyle = p.c; ctx.fillRect(p.x, p.y, p.s, p.s);
            });
            frame++;
            if (active) requestAnimationFrame(loop); else ctx.clearRect(0,0,canvas.width, canvas.height);
        }
        loop();
    }

    // --- LIBRARY FEATURE ---
    function switchLibTab(tab) {
        currentLibTab = tab;
        document.querySelectorAll('.library-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderLibrary();
    }

    function renderLibrary(filterText = "") {
        const container = document.getElementById('library-content');
        container.innerHTML = "";
        
        let sourceData = [];
        if(currentLibTab === 'models') sourceData = DB_MODELS;
        else if(currentLibTab === 'productivity') sourceData = DB_PRODUCTIVITY;
        else if(currentLibTab === 'investors') sourceData = DB_INVESTORS;
        else if(currentLibTab === 'quotes') sourceData = DB_QUOTES.map(q => ({ name: "Quote", desc: q }));

        sourceData.forEach(item => {
            // Simple search filtering
            if(filterText && !item.name.toLowerCase().includes(filterText.toLowerCase()) && !item.desc.toLowerCase().includes(filterText.toLowerCase())) return;
            
            const div = document.createElement('div');
            div.className = 'library-item';
            if (currentLibTab === 'investors') {
                div.innerHTML = `<div class="lib-title">${item.name} (${item.years})</div><div class="lib-desc">${item.resource}</div>`;
            } else {
                div.innerHTML = `<div class="lib-title">${item.name}</div><div class="lib-desc">${item.desc}</div>`;
            }
            container.appendChild(div);
        });
    }
    
    function filterLibrary() {
        const txt = document.getElementById('lib-search').value;
        renderLibrary(txt);
    }

    // --- STATS LOGIC ---
    function renderStats() {
        const container = document.getElementById('stats-chart');
        container.innerHTML = '';
        const today = new Date();
        
        for (let i=6; i>=0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const iso = d.toISOString().slice(0,10);
            const key = formatDateKey(iso);
            const raw = localStorage.getItem(key);
            let xp = 0;
            if (raw) {
                const state = JSON.parse(raw);
                const calculated = calculateXP(state);
                xp = Object.values(calculated).reduce((a,b)=>a+b,0);
            }

            const pct = Math.min(100, (xp / CONSTANTS.MAX_XP) * 100);
            let cls = 'red';
            if (xp >= CONSTANTS.XP_LEVELS.ELITE) cls = 'elite';
            else if (xp >= CONSTANTS.XP_LEVELS.STRONG) cls = 'strong';
            else if (xp >= CONSTANTS.XP_LEVELS.SURVIVAL) cls = 'survival';

            const group = document.createElement('div');
            group.className = 'bar-group';
            group.innerHTML = `
                <div class="bar-value">${xp > 0 ? (xp/1000).toFixed(1)+'k' : ''}</div>
                <div class="bar ${cls}" style="height:${pct}%"></div>
                <div class="bar-label">${iso.slice(5)}</div>
            `;
            container.appendChild(group);
        }
        els.modals.stats.style.display = 'flex';
    }

    // --- APP FLOW ---
    function loadDay() {
      const date = els.dateInput.value || getTodayISO();
      updateDynamicContent(date);
      const raw = localStorage.getItem(formatDateKey(date));
      writeState(raw ? JSON.parse(raw) : {});
      updateVisuals();
    }

    function saveDay() {
      const date = els.dateInput.value || getTodayISO();
      const state = readState();
      localStorage.setItem(formatDateKey(date), JSON.stringify(state));
      const total = updateVisuals();
      if (total >= CONSTANTS.XP_LEVELS.ELITE) {
        fireConfetti();
        setTimeout(() => alert('JAGUAR STATUS ACHIEVED. Legacy building in progress.'), 100);
      } else {
        alert('Day progress saved.');
      }
    }

    // Event Listeners
    getCheckboxes().forEach(cb => cb.addEventListener('change', handleCheck));
    els.dateInput.addEventListener('change', loadDay);
    els.saveBtn.addEventListener('click', saveDay);
    els.resetBtn.addEventListener('click', () => { 
        if(confirm("Clear all progress for this date?")) { writeState({}); updateVisuals(); }
    });
    
    // Modals
    els.settingsBtn.addEventListener('click', () => {
        document.getElementById('export-area').value = JSON.stringify({...localStorage}, null, 2);
        els.modals.data.style.display = 'flex';
    });
    els.statsBtn.addEventListener('click', renderStats);
    els.libraryBtn.addEventListener('click', () => {
        renderLibrary();
        els.modals.library.style.display = 'flex';
    });
    
    document.getElementById('close-data-modal').onclick = () => els.modals.data.style.display = 'none';
    document.getElementById('close-stats-modal').onclick = () => els.modals.stats.style.display = 'none';
    document.getElementById('close-lib-modal').onclick = () => els.modals.library.style.display = 'none';
    
    document.getElementById('restore-btn').onclick = () => {
        try {
            const data = JSON.parse(document.getElementById('export-area').value);
            if (confirm("Overwrite data?")) {
                localStorage.clear();
                Object.keys(data).forEach(k => localStorage.setItem(k, data[k]));
                els.modals.data.style.display = 'none';
                loadDay();
            }
        } catch(e) { alert("Invalid JSON"); }
    };

    // Init
    els.dateInput.value = getTodayISO();
    loadDay();

  </script>
</body>
</html>
